version: '3.8'

services:
  unsloth-training:
    build: .
    container_name: unsloth-training
    environment:
      - JUPYTER_PASSWORD=unsloth
      - JUPYTER_PORT=8888
      - USER_PASSWORD=unsloth2024
      # Unsloth関連
      - UNSLOTH_COMPILE_CACHE=/tmp/unsloth_compiled_cache
      - HF_HOME=/workspace/work/models/cache/huggingface
      - TRANSFORMERS_CACHE=/workspace/work/models/cache/huggingface
      # MLflow関連
      - MLFLOW_TRACKING_URI=file:///workspace/work/mlruns
      # vLLM関連
      - VLLM_ATTENTION_BACKEND=FLASHINFER
    volumes:
      - ./data:/workspace/work/data
      - ./models:/workspace/work/models
      - ./scripts:/workspace/work/scripts
      - ./notebooks:/workspace/work/notebooks
      - ./configs:/workspace/work/configs
      - ./mlruns:/workspace/work/mlruns
    ports:
      - "8888:8888"    # Jupyter Lab
      - "5000:5000"    # MLflow UI
      - "8000:8000"    # vLLM API Server
      - "2222:22"      # SSH
    shm_size: '8gb'
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
